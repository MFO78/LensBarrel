<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Optical Lens Designer</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', system-ui, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid #334155; }
        .modal-overlay { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(5px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Micro-Catalogue containing standard and explicitly Apo-grade materials
        const initialDatabase = [
            { id: 'N-BK7-SCHOTT', name: 'N-BK7', catalog: 'SCHOTT', formula: 2, nd: 1.5168, vd: 64.17, coeffs: [1.03961212, 0.00600069867, 0.231792344, 0.0200179144, 1.01046945, 103.560653], ldMin: 0.3, ldMax: 2.5, isApoGrade: false },
            { id: 'F2-SCHOTT', name: 'F2', catalog: 'SCHOTT', formula: 2, nd: 1.6200, vd: 36.37, coeffs: [1.34533359, 0.00997743871, 0.209073176, 0.0470450767, 0.937357162, 111.886764], ldMin: 0.33, ldMax: 2.5, isApoGrade: false },
            { id: 'CaF2-SCHOTT', name: 'CaF2', catalog: 'SCHOTT', formula: 2, nd: 1.4338, vd: 95.10, coeffs: [0.5675888, 0.00252643, 0.4710914, 0.01007833, 3.8484723, 1200.556], ldMin: 0.2, ldMax: 8.0, isApoGrade: true },
            { id: 'N-PK52A-SCHOTT', name: 'N-PK52A', catalog: 'SCHOTT', formula: 2, nd: 1.4970, vd: 81.61, coeffs: [0.9312389, 0.0048154, 0.3015694, 0.0152541, 0.8906322, 110.1601], ldMin: 0.3, ldMax: 2.5, isApoGrade: true },
            { id: 'H-K9L-CDGM', name: 'H-K9L', catalog: 'CDGM', formula: 2, nd: 1.5168, vd: 64.20, coeffs: [1.03961212, 0.00600069867, 0.231792344, 0.0200179144, 1.01046945, 103.560653], ldMin: 0.3, ldMax: 2.5, isApoGrade: false },
            { id: 'H-F4-CDGM', name: 'H-F4', catalog: 'CDGM', formula: 2, nd: 1.6166, vd: 36.61, coeffs: [1.34533359, 0.00997743871, 0.209073176, 0.0470450767, 0.937357162, 111.886764], ldMin: 0.33, ldMax: 2.5, isApoGrade: false }
        ];

        // Icons
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const IconSearch = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconInfo = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;
        const IconClose = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const IconRefresh = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;

        const App = () => {
            const [database, setDatabase] = useState(initialDatabase);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterCatalog, setFilterCatalog] = useState('ALL');
            const [filterApo, setFilterApo] = useState(false);
            const [message, setMessage] = useState('');
            const [showHelp, setShowHelp] = useState(true);
            const [swapContext, setSwapContext] = useState(null); 
            const [swapFilterCatalog, setSwapFilterCatalog] = useState('ALL');
            
            const defaultInputs = {
                numLenses: 2, efl: 1500, fov: 1.5, waveCenter: 587.6, waveBand: 200,
                minThickness: 2.0, m1Roc: -3000, m1Conic: -1, m2Roc: -500, m2Conic: -2.5,
                m1m2Space: 1000, pupilDia: 300
            };
            const [inputs, setInputs] = useState(defaultInputs);
            const [results, setResults] = useState(null);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('lensDesignerConfig');
                    if (saved) setInputs({ ...defaultInputs, ...JSON.parse(saved) });
                } catch (e) { console.error("Failed to parse saved config."); }
            }, []);

            const saveConfig = () => {
                try {
                    localStorage.setItem('lensDesignerConfig', JSON.stringify(inputs));
                    showMessage("Configuration successfully saved to local storage.");
                } catch (e) { showMessage("Failed to save configuration.", true); }
            };

            const isValidWave = (glass, waveNm) => {
                const w = waveNm / 1000.0;
                return w >= glass.ldMin && w <= glass.ldMax;
            };

            const getIndexAtWave = (glass, waveNm) => {
                if (!glass || !glass.coeffs || glass.coeffs.length < 6 || isNaN(waveNm) || waveNm <= 0) return glass ? glass.nd : 1.5;
                const w = waveNm / 1000.0; 
                const w2 = w * w;
                const c = glass.coeffs;
                try {
                    let n2 = 0;
                    if (glass.formula === 1) n2 = c[0] + c[1]*w2 + c[2]/w2 + c[3]/Math.pow(w, 4) + c[4]/Math.pow(w, 6) + c[5]/Math.pow(w, 8);
                    else if (glass.formula === 2) n2 = 1 + (c[0]*w2)/(w2 - c[1]) + (c[2]*w2)/(w2 - c[3]) + (c[4]*w2)/(w2 - c[5]);
                    else return glass.nd; 
                    
                    const actualNd = Math.sqrt(n2);
                    return (!isNaN(actualNd) && actualNd > 1.0) ? actualNd : glass.nd;
                } catch (e) { return glass.nd; }
            };

            // Calculate exact V and P based on user wavelength band
            const calculatePV = (glass) => {
                const wCenter = inputs.waveCenter;
                const wShort = wCenter - (inputs.waveBand / 2);
                const wLong = wCenter + (inputs.waveBand / 2);
                
                const nd = getIndexAtWave(glass, wCenter);
                const nShort = getIndexAtWave(glass, wShort);
                const nLong = getIndexAtWave(glass, wLong);
                
                const denominator = (nShort - nLong) || 1e-6; // Prevent div zero
                const v = (nd - 1) / denominator;
                const p = (nShort - nd) / denominator;
                
                return { v, p, nd };
            };

            const calculateSystemMF = (lenses, targetEFL, waveNm) => {
                const mult = (m1, m2) => [
                    m1[0]*m2[0] + m1[1]*m2[2], m1[0]*m2[1] + m1[1]*m2[3],
                    m1[2]*m2[0] + m1[3]*m2[2], m1[2]*m2[1] + m1[3]*m2[3]
                ];
                let currentMatrix = [1, 0, 0, 1]; 
                lenses.forEach(lens => {
                    const mat = database.find(g => g.name === lens.material && g.catalog === lens.catalog) || database[0];
                    const n = getIndexAtWave(mat, waveNm);
                    const r1 = parseFloat(lens.r1);
                    const P1 = isNaN(r1) || r1 === 0 ? 0 : (n - 1) / r1;
                    currentMatrix = mult([1, 0, -P1, 1], currentMatrix);
                    const t = parseFloat(lens.thickness);
                    currentMatrix = mult([1, t / n, 0, 1], currentMatrix);
                    const r2 = parseFloat(lens.r2);
                    const P2 = isNaN(r2) || r2 === 0 ? 0 : (1 - n) / r2;
                    currentMatrix = mult([1, 0, -P2, 1], currentMatrix);
                });
                const sysPower = -currentMatrix[2];
                const calcEFL = sysPower !== 0 ? 1 / sysPower : 999999;
                
                const mfRaw = Math.pow(Math.abs(calcEFL - targetEFL), 2);
                const mfFormatted = mfRaw > 10000 ? mfRaw.toExponential(4) : mfRaw.toFixed(2);
                
                return { calcEFL: calcEFL.toFixed(2), mf: mfFormatted };
            };

            // Paraxial Ray Trace (PRT) Helper
            const traceMarginalRay = (m1Roc, m2Roc, spacing, epd) => {
                // Simplified Paraxial Trace: Object @ Infinity -> M1 -> M2 -> Lens 1 Surface
                // 1. Ray hits M1 at height y1 = EPD / 2
                const y1 = epd / 2;
                
                // 2. Reflection at M1 (Power P1 = 2/R1)
                // Angle u1_out = u1_in - y1 * P1. u1_in = 0 (infinity).
                const P1 = 2.0 / m1Roc;
                const u1_out = -y1 * P1;
                
                // 3. Transfer to M2 (distance = spacing)
                // y2 = y1 + u1_out * spacing
                const y2 = y1 + u1_out * spacing;
                
                // 4. Reflection at M2 (Power P2 = 2/R2)
                // u2_out = u1_out - y2 * P2
                const P2 = 2.0 / m2Roc;
                const u2_out = u1_out - y2 * P2;
                
                // 5. Transfer to Lens 1 (Assume L1 is near M1 vertex ~ spacing distance back)
                // Note: This is a Cassegrain-style assumption where correctors are near the primary hole.
                const y_lens1 = y2 + u2_out * spacing;
                
                // Return absolute height for clear aperture estimation
                return Math.abs(y_lens1);
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/);
                    let catalogName = file.name.replace('.AGF', '').toUpperCase();
                    let newGlasses = [];
                    let currentGlass = null;

                    lines.forEach(line => {
                        if (line.startsWith('NM ')) {
                            if (currentGlass && currentGlass.nd > 1.0 && currentGlass.coeffs.length >= 6) {
                                newGlasses.push(currentGlass);
                            }
                            const parts = line.split(/\s+/);
                            if (parts.length >= 6) {
                                // Auto-flag known low-dispersion fluorides as Apo-grade
                                const isApo = parts[1].includes('F2') || parts[1].includes('PK') || parts[1].includes('FK') || parseFloat(parts[5]) > 70;
                                currentGlass = {
                                    id: `${parts[1]}-${catalogName}`,
                                    name: parts[1], catalog: catalogName,
                                    formula: parseInt(parts[2]) || 2,
                                    nd: parseFloat(parts[4]), vd: parseFloat(parts[5]),
                                    coeffs: [], ldMin: 0.3, ldMax: 2.5,
                                    isApoGrade: isApo 
                                };
                            }
                        } else if (line.startsWith('CD ') && currentGlass) {
                            currentGlass.coeffs = line.split(/\s+/).slice(1, 7).map(parseFloat);
                        } else if (line.startsWith('LD ') && currentGlass) {
                            const parts = line.split(/\s+/);
                            if (parts.length >= 3) {
                                currentGlass.ldMin = parseFloat(parts[1]);
                                currentGlass.ldMax = parseFloat(parts[2]);
                            }
                        }
                    });
                    
                    if (currentGlass && currentGlass.nd > 1.0 && currentGlass.coeffs.length >= 6) {
                        newGlasses.push(currentGlass);
                    }

                    if (newGlasses.length > 0) {
                        setDatabase(prev => {
                            const merged = [...prev, ...newGlasses];
                            return Array.from(new Map(merged.map(item => [item.id, item])).values());
                        });
                        showMessage(`Loaded ${newGlasses.length} valid materials from ${file.name}.`);
                    } else {
                        showMessage(`No valid material data found in ${file.name}.`, true);
                    }
                };
                reader.readAsText(file);
            };

            const showMessage = (msg, isError = false) => {
                setMessage(msg);
                setTimeout(() => setMessage(''), 4000);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setInputs(prev => ({ ...prev, [name]: parseFloat(value) || value }));
            };

            const runApochromaticOptimisation = () => {
                const validGlasses = database.filter(g => isValidWave(g, inputs.waveCenter));
                if (validGlasses.length < 2) {
                    showMessage("Error: Insufficient database materials support this λ wavelength.", true);
                    return;
                }

                // Compute exact P and V for all valid glasses
                const pvMap = validGlasses.map(g => ({ glass: g, ...calculatePV(g) }));
                
                // Heuristic: Find the best Crown/Flint pair to minimise delta P, maximise delta V
                let bestPair = null;
                let bestScore = -999999;
                
                const crowns = pvMap.filter(g => g.v > 50);
                const flints = pvMap.filter(g => g.v <= 50);
                
                if (crowns.length === 0 || flints.length === 0) {
                    showMessage("Error: Database lacks sufficient dispersion variety for Apo mapping.", true);
                    return;
                }

                crowns.forEach(c => {
                    flints.forEach(f => {
                        const deltaP = Math.abs(c.p - f.p);
                        const deltaV = Math.abs(c.v - f.v);
                        if (deltaV > 15) {
                            // Weight score: Heavily penalise P mismatch, reward V difference
                            const score = deltaV - (deltaP * 5000); 
                            if (score > bestScore) {
                                bestScore = score;
                                bestPair = { crown: c, flint: f };
                            }
                        }
                    });
                });

                if (!bestPair) bestPair = { crown: crowns[0], flint: flints[0] }; // Fallback

                let newResults = [];
                const targetPower = 1 / (inputs.efl || 1500); 
                const minThickness = parseFloat(inputs.minThickness) || 1.0;
                const numLenses = parseInt(inputs.numLenses) || 2;
                
                // PRT Upgrade: Calculate geometric ray height
                let geoRayHeight = 0;
                if (inputs.m1Roc && inputs.m2Roc && inputs.m1m2Space && inputs.pupilDia) {
                    geoRayHeight = traceMarginalRay(inputs.m1Roc, inputs.m2Roc, inputs.m1m2Space, inputs.pupilDia);
                }
                
                for (let i = 0; i < numLenses; i++) {
                    // For > 2 lenses, alternate basic logic, but true apochromatism is seeded in the first doublet pair
                    const isCrown = i % 2 === 0;
                    const pvMat = isCrown ? bestPair.crown : bestPair.flint;

                    // PRT Upgrade: Use traced ray height if valid, else fall back to FOV approx
                    let approxDia = 0;
                    if (geoRayHeight > 0) {
                        approxDia = geoRayHeight * 2.2; // 10% safety margin on radius * 2 = diam
                    } else {
                        approxDia = (inputs.efl || 1500) * Math.tan(((inputs.fov || 1.5) * Math.PI / 180) / 2) * 2;
                    }
                    
                    let thickness = Math.max(minThickness, parseFloat((approxDia * 0.1).toFixed(2)));
                    
                    // Exact Apochromatic Power Distribution: Phi1 = Phi_sys * [V1 / (V1 - V2)]
                    const dV = bestPair.crown.v - bestPair.flint.v;
                    let pwrCont = isCrown 
                        ? targetPower * (bestPair.crown.v / dV)
                        : targetPower * (-bestPair.flint.v / dV);
                    
                    if (numLenses > 2) {
                        // Dampen analytical power for N>2 to allow optimiser freedom without exceeding Target EFL
                        pwrCont = pwrCont * (2 / numLenses);
                    }
                    if (pwrCont === 0) pwrCont = 0.0001;
                    
                    let r1 = ((pvMat.nd - 1) / pwrCont).toFixed(2);
                    let r2 = (-r1).toFixed(2); 
                    
                    if (Math.abs(r1) > 10000) r1 = "Infinity";
                    if (Math.abs(r2) > 10000) r2 = "Infinity";

                    newResults.push({
                        lensNum: i + 1,
                        isCrown: isCrown,
                        material: pvMat.glass.name,
                        catalog: pvMat.glass.catalog,
                        nd: pvMat.glass.nd,
                        actualNd: pvMat.nd.toFixed(5),
                        vd: pvMat.v.toFixed(2),
                        pd: pvMat.p.toFixed(4),
                        r1: r1,
                        r2: r2,
                        thickness: thickness.toFixed(2),
                        conic: 0 
                    });
                }

                const metrics = calculateSystemMF(newResults, inputs.efl, inputs.waveCenter);
                setResults({ timestamp: new Date().toLocaleTimeString(), lenses: newResults, metrics: metrics });
                showMessage(geoRayHeight > 0 
                    ? "Prescription generated using Active Paraxial Ray Trace (PRT)." 
                    : "Prescription generated via P vs V Analytical Mapping (FOV approx).");
            };

            const executeSwap = (lensIndex, newMat) => {
                const pvMat = calculatePV(newMat);
                let updatedLenses = [...results.lenses];
                updatedLenses[lensIndex] = {
                    ...updatedLenses[lensIndex],
                    material: newMat.name, catalog: newMat.catalog,
                    nd: newMat.nd, actualNd: pvMat.nd.toFixed(5), vd: pvMat.v.toFixed(2), pd: pvMat.p.toFixed(4)
                };
                const metrics = calculateSystemMF(updatedLenses, inputs.efl, inputs.waveCenter);
                setResults({ ...results, lenses: updatedLenses, metrics: metrics });
                setSwapContext(null);
            };

            const filteredDB = database.filter(g => 
                (filterCatalog === 'ALL' || g.catalog === filterCatalog) &&
                (!filterApo || g.isApoGrade) &&
                (g.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                 g.catalog.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            const catalogs = ['ALL', ...new Set(database.map(g => g.catalog))];

            // Render logic for Swap Modal Pool
            let swapPool = [];
            if (swapContext) {
                const validWavelengthGlasses = database.filter(g => isValidWave(g, inputs.waveCenter));
                const pvMap = validWavelengthGlasses.map(g => ({ glass: g, ...calculatePV(g) }));
                
                const basePool = swapContext.targetRole === 'CROWN' 
                    ? pvMap.filter(g => g.v > 50)
                    : pvMap.filter(g => g.v <= 50);

                swapPool = basePool.filter(pv => swapFilterCatalog === 'ALL' || pv.glass.catalog === swapFilterCatalog);
            }

            return (
                <div className="min-h-screen p-4 md:p-6 flex flex-col gap-6 relative">
                    
                    {/* Splash Screen / Help Modal */}
                    {showHelp && (
                        <div className="fixed inset-0 z-[999] flex items-center justify-center modal-overlay p-4" onClick={() => setShowHelp(false)}>
                            <div className="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-2xl w-full p-6 relative cursor-default" onClick={(e) => e.stopPropagation()}>
                                <button onClick={() => setShowHelp(false)} className="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors" title="Close Help"><IconClose /></button>
                                <h2 className="text-2xl font-bold text-emerald-400 mb-4 border-b border-slate-700 pb-2">Analytical Apochromatic Engine</h2>
                                
                                <div className="space-y-4 text-sm text-slate-300 max-h-[60vh] overflow-y-auto pr-2">
                                    <div><h3 className="text-white font-semibold mb-1">1. Active Paraxial Ray Trace (PRT)</h3><p>The engine now explicitly traces the marginal ray from the Entrance Pupil through the M1 and M2 reflections. Lens diameters and edge thicknesses are driven by the actual physical light cone entering the corrector group.</p></div>
                                    <div><h3 className="text-white font-semibold mb-1">2. P vs V Dispersion Mapping</h3><p>Unlike standard achromats, this engine calculates both the exact Abbe Number (V) and Relative Partial Dispersion (P) dynamically for your specific λ boundary inputs. It pairs materials by minimising ΔP while maximising ΔV.</p></div>
                                    <div><h3 className="text-white font-semibold mb-1">3. Exact Power Formulation</h3><p>Instead of basic heuristics, optical power is distributed analytically: Φ_1 = Φ_sys * [V_1 / (V_1 - V_2)]. This precisely balances the primary colour foci prior to the paraxial thick-lens translation error.</p></div>
                                </div>
                                <div className="mt-6 pt-4 border-t border-slate-700 flex justify-end">
                                    <button onClick={() => setShowHelp(false)} className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded-lg font-medium transition-colors">Acknowledge & Start</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Swap Modal */}
                    {swapContext && (
                        <div className="fixed inset-0 z-[990] flex items-center justify-center modal-overlay p-4" onClick={() => setSwapContext(null)}>
                            <div className="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-lg w-full p-6 relative cursor-default flex flex-col max-h-[80vh]" onClick={(e) => e.stopPropagation()}>
                                <button onClick={() => setSwapContext(null)} className="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors"><IconClose /></button>
                                <h2 className="text-xl font-bold text-emerald-400 mb-2">Apochromatic Material Substitution</h2>
                                <p className="text-xs text-slate-400 mb-4 pb-4 border-b border-slate-700">Replacing Lens {swapContext.lensIndex + 1} • Requires <span className={`px-1.5 py-0.5 rounded text-white font-bold ${swapContext.targetRole === 'CROWN' ? 'bg-blue-900' : 'bg-rose-900'}`}>{swapContext.targetRole}</span> valid at {inputs.waveCenter} nm.</p>
                                
                                <div className="mb-4">
                                    <label className="block text-xs text-slate-400 mb-1">Filter by Catalogue Source:</label>
                                    <select 
                                        className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none"
                                        value={swapFilterCatalog}
                                        onChange={(e) => setSwapFilterCatalog(e.target.value)}
                                    >
                                        {catalogs.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                    </select>
                                </div>

                                <div className="flex-1 overflow-y-auto border border-slate-700 rounded bg-slate-900/50 p-2">
                                    {swapPool.length === 0 ? (
                                        <div className="text-center py-8 text-slate-500 text-sm">No valid materials found.</div>
                                    ) : (
                                        <div className="space-y-1">
                                            {swapPool.map(pv => (
                                                <button 
                                                    key={pv.glass.id} 
                                                    onClick={() => executeSwap(swapContext.lensIndex, pv.glass)}
                                                    className="w-full text-left px-3 py-2 rounded hover:bg-emerald-900/40 border border-transparent hover:border-emerald-700 transition-colors flex justify-between items-center group"
                                                >
                                                    <div>
                                                        <div className="font-mono text-emerald-300 group-hover:text-emerald-400">{pv.glass.name}</div>
                                                        <div className="text-xs text-slate-500">Cat: {pv.glass.catalog} | P: {pv.p.toFixed(4)}</div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-xs text-slate-400">V @ Target</div>
                                                        <div className="font-mono text-white text-sm">{pv.v.toFixed(2)}</div>
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="flex justify-between items-center pb-4 border-b border-slate-700">
                        <div>
                            <div className="flex items-center gap-3">
                                <h1 className="text-2xl font-bold tracking-tight text-white">Advanced Optical Lens Designer</h1>
                                <button onClick={() => setShowHelp(true)} className="p-1.5 bg-slate-800 text-emerald-400 rounded-full hover:bg-slate-700 transition-colors" title="View Math Models"><IconInfo /></button>
                            </div>
                            <p className="text-sm text-slate-400">Paraxial Heuristic Engine v3.1 • Active PRT Enabled</p>
                        </div>
                        {message && (
                            <div className="bg-blue-900/50 text-blue-200 px-4 py-2 rounded-lg border border-blue-700 text-sm animate-pulse">{message}</div>
                        )}
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-1">
                        
                        {/* LEFT COLUMN: Inputs */}
                        <div className="lg:col-span-3 space-y-4">
                            <div className="glass-panel p-4 rounded-xl">
                                <h2 className="text-lg font-semibold mb-4 text-emerald-400">System Parameters</h2>
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-xs text-slate-400 mb-1">Number of Lenses (Corrector)</label>
                                        <input type="number" name="numLenses" value={inputs.numLenses} onChange={handleInputChange} min="1" max="10" className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-emerald-500 outline-none text-white" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block text-xs text-slate-400 mb-1">Target EFL (mm)</label><input type="number" name="efl" value={inputs.efl} onChange={handleInputChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-emerald-500 outline-none text-white" /></div>
                                        <div><label className="block text-xs text-slate-400 mb-1">Overall FoV (°)</label><input type="number" name="fov" value={inputs.fov} onChange={handleInputChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-emerald-500 outline-none text-white" /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block text-xs text-slate-400 mb-1">λ Center (nm)</label><input type="number" name="waveCenter" value={inputs.waveCenter} onChange={handleInputChange} className="w-full bg-emerald-900/30 border border-emerald-600/50 rounded p-2 text-sm focus:border-emerald-500 outline-none text-emerald-300 font-bold" /></div>
                                        <div><label className="block text-xs text-slate-400 mb-1">λ Band (nm)</label><input type="number" name="waveBand" value={inputs.waveBand} onChange={handleInputChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-emerald-500 outline-none text-white" /></div>
                                    </div>
                                    <div><label className="block text-xs text-slate-400 mb-1">Min Centre Thickness (mm)</label><input type="number" name="minThickness" value={inputs.minThickness} onChange={handleInputChange} step="0.1" className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-emerald-500 outline-none text-white" /></div>
                                </div>
                            </div>

                            <div className="glass-panel p-4 rounded-xl">
                                <h2 className="text-lg font-semibold mb-4 text-blue-400">Reflector Geometry</h2>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block text-xs text-slate-400 mb-1">M1 Radius</label><input type="number" name="m1Roc" value={inputs.m1Roc} onChange={handleInputChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" /></div>
                                        <div><label className="block text-xs text-slate-400 mb-1">M1 Conic</label><input type="number" name="m1Conic" value={inputs.m1Conic} onChange={handleInputChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block text-xs text-slate-400 mb-1">M2 Radius</label><input type="number" name="m2Roc" value={inputs.m2Roc} onChange={handleInputChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" /></div>
                                        <div><label className="block text-xs text-slate-400 mb-1">M2 Conic</label><input type="number" name="m2Conic" value={inputs.m2Conic} onChange={handleInputChange} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-blue-500 outline-none text-white" /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="block text-xs text-slate-400 mb-1">M1-M2 Sep. (mm)</label><input type="number" name="m1m2Space" value={inputs.m1m2Space} onChange={handleInputChange} className="w-full bg-blue-900/30 border border-blue-600/50 rounded p-2 text-sm focus:border-blue-500 outline-none text-blue-300 font-bold" /></div>
                                        <div><label className="block text-xs text-slate-400 mb-1">Entrance Pupil (mm)</label><input type="number" name="pupilDia" value={inputs.pupilDia} onChange={handleInputChange} className="w-full bg-blue-900/30 border border-blue-600/50 rounded p-2 text-sm focus:border-blue-500 outline-none text-blue-300 font-bold" /></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <button onClick={saveConfig} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-medium py-3 px-2 rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg">
                                    <IconSave /> Save Config
                                </button>
                                <button onClick={runApochromaticOptimisation} className="flex-[2] bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-3 px-2 rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/20">
                                    <IconPlay /> P-V Optimise
                                </button>
                            </div>
                        </div>

                        {/* CENTER COLUMN: Results */}
                        <div className="lg:col-span-5 flex flex-col gap-4">
                            <div className="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden">
                                <div className="p-4 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                                    <h2 className="text-lg font-semibold text-white">Apochromatic Prescription</h2>
                                    {results && (
                                        <div className="text-right">
                                            <div className="text-xs text-slate-400">Calculated EFL: <span className="text-white font-mono">{results.metrics.calcEFL}</span> mm</div>
                                            <div className="text-xs text-emerald-400 font-bold">Merit Func (MF): {results.metrics.mf}</div>
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 flex-1 overflow-auto">
                                    {!results ? (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-500 space-y-4">
                                            <div className="w-16 h-16 rounded-full border-4 border-slate-700 border-t-emerald-500 animate-spin"></div>
                                            <p>Awaiting Apochromatic Analysis...</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {results.lenses.map((lens, idx) => (
                                                <div key={idx} className="bg-slate-800 border border-slate-600 rounded-lg p-3">
                                                    <div className="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                                                        <div className="flex items-center gap-2">
                                                            <h3 className="font-bold text-emerald-400">Lens {lens.lensNum}</h3>
                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded ${lens.isCrown ? 'bg-blue-900/50 text-blue-300' : 'bg-rose-900/50 text-rose-300'}`}>{lens.isCrown ? 'CROWN' : 'FLINT'}</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs px-2 py-1 bg-slate-700 rounded text-slate-300">{lens.catalog}</span>
                                                            <button 
                                                                onClick={() => setSwapContext({ lensIndex: idx, targetRole: lens.isCrown ? 'CROWN' : 'FLINT' })} 
                                                                className="flex items-center gap-1 text-xs bg-slate-700 hover:bg-emerald-600 text-white px-2 py-1 rounded transition-colors" 
                                                                title="Select Specific Material From Catalogue"
                                                            >
                                                                <IconRefresh /> Target Swap
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-y-2 gap-x-4 text-sm mt-2">
                                                        <div className="flex justify-between"><span className="text-slate-400">Material:</span><span className="font-mono text-white font-bold">{lens.material}</span></div>
                                                        <div className="flex justify-between"><span className="text-slate-400">Thickness:</span><span className="font-mono text-white">{lens.thickness} mm</span></div>
                                                        <div className="flex justify-between bg-emerald-900/20 rounded px-1 -mx-1"><span className="text-emerald-300/80">Idx @ Cntr:</span><span className="font-mono text-emerald-300">{lens.actualNd}</span></div>
                                                        <div className="flex justify-between"><span className="text-slate-400">Disp P/V:</span><span className="font-mono text-white">{lens.pd} / {lens.vd}</span></div>
                                                        <div className="flex justify-between"><span className="text-slate-400">R1 / Conic:</span><span className="font-mono text-white">{lens.r1} / {lens.conic}</span></div>
                                                        <div className="flex justify-between"><span className="text-slate-400">R2 / Conic:</span><span className="font-mono text-white">{lens.r2} / {lens.conic}</span></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: Database */}
                        <div className="lg:col-span-4 flex flex-col gap-4">
                            <div className="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden max-h-[800px]">
                                <div className="p-4 border-b border-slate-700 bg-slate-800/50 space-y-3">
                                    <h2 className="text-lg font-semibold text-white flex items-center gap-2">
                                        Material Database
                                        <span className="bg-slate-700 text-xs py-0.5 px-2 rounded-full">{database.length}</span>
                                    </h2>
                                    
                                    <div className="flex gap-2">
                                        <div className="relative flex-1">
                                            <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none text-slate-400"><IconSearch /></div>
                                            <input type="text" placeholder="Search glass..." className="w-full pl-8 pr-2 py-1.5 bg-slate-900 border border-slate-600 rounded text-sm focus:border-emerald-500 outline-none text-white" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                        </div>
                                        <button 
                                            onClick={() => setFilterApo(!filterApo)}
                                            className={`p-1.5 rounded border transition-colors ${filterApo ? 'bg-emerald-900/50 border-emerald-500 text-emerald-400' : 'bg-slate-900 border-slate-600 text-slate-400 hover:text-white'}`}
                                            title="Toggle Apo-Grade (Fluoride) Materials"
                                        >
                                            <IconFilter />
                                        </button>
                                        <select 
                                            className="bg-slate-900 border border-slate-600 rounded px-2 py-1.5 text-sm text-white focus:border-emerald-500 outline-none w-24"
                                            value={filterCatalog}
                                            onChange={(e) => setFilterCatalog(e.target.value)}
                                        >
                                            {catalogs.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-auto p-2">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-slate-400 bg-slate-800/50 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2">Name</th>
                                                <th className="px-3 py-2">Cat.</th>
                                                <th className="px-3 py-2 text-right">Apo-Grade</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredDB.map((glass, idx) => (
                                                <tr key={idx} className="border-b border-slate-700/50 hover:bg-slate-800 transition-colors">
                                                    <td className="px-3 py-2 font-mono text-emerald-400">{glass.name}</td>
                                                    <td className="px-3 py-2 text-xs text-slate-400">{glass.catalog}</td>
                                                    <td className="px-3 py-2 text-right">
                                                        {glass.isApoGrade ? <span className="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span> : <span className="w-2 h-2 rounded-full bg-slate-600 inline-block"></span>}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div className="p-3 border-t border-slate-700 bg-slate-800/30">
                                    <label className="flex items-center justify-center gap-2 w-full border-2 border-dashed border-slate-600 rounded-lg p-3 hover:border-emerald-500 hover:bg-slate-800 transition-colors cursor-pointer group">
                                        <IconUpload />
                                        <span className="text-sm text-slate-400 group-hover:text-emerald-400 transition-colors">Upload .AGF Database</span>
                                        <input type="file" accept=".agf" className="hidden" onChange={handleFileUpload} />
                                    </label>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
